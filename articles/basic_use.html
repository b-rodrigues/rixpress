<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Setting up a simple pipeline • rixpress</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Setting up a simple pipeline">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rixpress</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/basic_use.html">Setting up a simple pipeline</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/b-rodrigues/rixpress/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Setting up a simple pipeline</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/b-rodrigues/rixpress/blob/master/vignettes/basic_use.Rmd" class="external-link"><code>vignettes/basic_use.Rmd</code></a></small>
      <div class="d-none name"><code>basic_use.Rmd</code></div>
    </div>

    
    
<p>This vignette will introduce some jargon and walk you through setting
up a simple pipeline using {rixpress}. This vignette will not go beyond
a simple pipeline that only builds R outputs; for polyglot pipelines,
see THIS OTHER VIGNETTE TO BE WRITTEN.</p>
<div class="section level2">
<h2 id="definitions">Definitions<a class="anchor" aria-label="anchor" href="#definitions"></a>
</h2>
<p>In Nix jargon, a derivation <em>is a specification for running an
executable on precisely defined input files to repeatably produce output
files at uniquely determined file system paths.</em> (<a href="https://nix.dev/manual/nix/2.25/language/derivations" class="external-link">source</a>)</p>
<p>In simpler terms, a derivation is a recipe with precisely defined
inputs, steps, and a fixed output, meaning that for exactly the same
inputs and exactly the same build steps, exactly the same output is
produced. This is important to understand because to always build
exactly the same output, several measures must be taken:</p>
<ul>
<li>A derivation must have all of its inputs declared explicitly.</li>
<li>Inputs include software dependencies as well as configuration flags
or environment variables; in other words, anything necessary for a build
process.</li>
<li>To ensure the exact same output is always built, the build process
occurs in an <em>hermetic</em> sandbox.</li>
</ul>
<p>This last point is quite important because the build process must
happen inside a sandbox. If you’re building your output and it requires,
say, Quarto, then Quarto must be explicitly listed as an input, even if
you already have Quarto installed on your system.</p>
<p>The same goes for an environment variable; for example, R users may
have to set the variable <code>JAVA_HOME</code> to make R aware of where
the Java runtime is installed. However, if Java is required for a
derivation, setting the variable <code>JAVA_HOME</code> outside of the
sandbox does not help; it must be set explicitly within the sandbox.
This also means that if you need to access an API, for example, it will
not work because no connection to the internet is allowed from within
the build sandbox. This may seem very restrictive, but if you think
about it, it makes sense if your goal is to achieve complete
reproducibility. Indeed, say that you need to use a function
<code>f()</code> to access an API to get data for your analysis: what
guarantee do you have that running <code>f()</code> today will yield the
same result as running <code>f()</code> in six months? One year? Will
this API even still be online? For reproducibility purposes, you should
obtain the data from this API, then version and/or archive it, and
continue using this data for your analysis (and share it with potential
reproducers of your study).</p>
</div>
<div class="section level2">
<h2 id="derivations">Derivations<a class="anchor" aria-label="anchor" href="#derivations"></a>
</h2>
<p>Derivation can be very simple, but also very complex. Here is an
example of a <em>simple</em> derivation:</p>
<pre><code>let
 pkgs = import (fetchTarball "https://github.com/rstats-on-nix/nixpkgs/archive/2025-04-11.tar.gz") {};

in

pkgs.stdenv.mkDerivation {
  name = "filtered_mtcars";
  buildInputs = [ pkgs.gawk ];
  dontUnpack = true;
  src = ./mtcars.csv;
  installPhase = ''
    mkdir -p $out
    awk -F',' 'NR==1 || $9=="1" { print }' $src &gt; $out/filtered.csv
  '';
}</code></pre>
<p>I will not go into details: the only thing that matters is that this
uses <code>awk</code>, a common unix data processing tool, to keep the
rows of the <code>mtcars.csv</code> where its 9th column (the
<code>am</code> column) equals 1. As you can see, a lot of boilerplate
code must be written to perform this simple action. However, this is
entirely, and completely, reproducible: the dependencies are declared
and pinned to a dated branch of our <code>rstats-on-nix/nixpkgs</code>
fork, and the only think that make this pipeline (well, it’s a bit of a
stretch to call this a <em>pipeline</em>) is if the
<code>mtcars.csv</code> file is not shared with it.</p>
<p>I could then add another step that uses <code>filtered.csv</code> as
an input and continue to process it. If we label the above code as
<code>f</code> and a subsequent chunk of Nix code to <code>g</code>,
then adding another step would essentially result in the following
computation: <code>mtcars |&gt; f |&gt; g</code>.</p>
<p>The goal of <a href="https://github.com/b-rodrigues/rixpress/" class="external-link">rixpress</a> is to help you write pipelines
like <code>mtcars |&gt; f |&gt; g</code> without needing to learn Nix,
but still benefit from its features.</p>
</div>
<div class="section level2">
<h2 id="defining-derivations">Defining derivations<a class="anchor" aria-label="anchor" href="#defining-derivations"></a>
</h2>
<p><a href="https://github.com/b-rodrigues/rixpress/" class="external-link">rixpress</a> comes with many functions to help you write
derivations; these typically start with the string <code>rxp_</code> and
all have roughly the same structure. Let’s start with
<code><a href="../reference/rxp_r.html">rxp_r()</a></code>. To generate the code from before, one would
write:</p>
<pre><code><span><span class="va">d1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rxp_r.html">rxp_r</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="va">filtered_mtcars</span>,</span>
<span>  expr <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">am</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
<p>This should be very familiar to users of the <a href="https://docs.ropensci.org/targets/" class="external-link">targets</a>
package: just like with the <code>tar_target()</code> function, one
needs to give a name to the derivation and then command to generate it.
That’s it: all the required Nix code gets generated by
<a href="https://github.com/b-rodrigues/rixpress/" class="external-link">rixpress</a>.</p>
<p><code>d1</code> however needs <code>mtcars</code> as an input, so we
first need to make it available to the pipeline. To read in any type of
files, you should use <code><a href="../reference/rxp_r_file.html">rxp_r_file()</a></code>:</p>
<pre><code><span><span class="va">d0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rxp_r_file.html">rxp_r_file</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="va">mtcars</span>,</span>
<span>  path <span class="op">=</span> <span class="st">'data/mtcars.csv'</span>,</span>
<span>  read_function <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">x</span>, sep <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
<p><code><a href="../reference/rxp_r_file.html">rxp_r_file()</a></code> uses an R function of only one argument
which should be the path to the file to be read. In this case, for
illustration purposes, we assume the columns in the
<code>mtcars.csv</code> file are separated by the <code>|</code> symbol.
So we use an anonymous function to set the correct separator and create
a temporary function of only one argument to read the path,
<code>'data/mtcars.csv'</code>.</p>
<p>To continue transforming the data, you only need to define a new
derivation:</p>
<pre><code><span><span class="va">d2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rxp_r.html">rxp_r</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="va">mtcars_mpg</span>,</span>
<span>  expr <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">filtered_mtcars</span>, <span class="va">mpg</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
<p>To build the pipeline, define a list of derivations:</p>
<pre><code><span><span class="va">derivs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">d0</span>, <span class="va">d1</span>, <span class="va">d2</span><span class="op">)</span></span></code></pre>
<p>and pass it to the <code><a href="../reference/rixpress.html">rixpress()</a></code> function:</p>
<pre><code><span><span class="fu"><a href="../reference/rixpress.html">rixpress</a></span><span class="op">(</span><span class="va">derivs</span><span class="op">)</span></span></code></pre>
<p>To avoid having to so much code, you can instead directly define the
list and pass it to <code><a href="../reference/rixpress.html">rixpress()</a></code> using
<code>|&gt;</code>:</p>
<pre><code>library(rixpress)

list(
  rxp_r_file(
    name = mtcars,
    path = 'data/mtcars.csv',
    read_function = \(x) (read.csv(file = x, sep = "|"))
  ),

  rxp_r(
    name = filtered_mtcars,
    expr = dplyr::filter(mtcars, am == 1)
  ),

  rxp_r(
    name = mtcars_mpg,
    expr = dplyr::select(filtered_mtcars, mpg)
  ) |&gt;
  rixpress()</code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bruno Rodrigues.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
