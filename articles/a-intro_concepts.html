<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introductory concepts • rixpress</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introductory concepts">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rixpress</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a-intro_concepts.html">Introductory concepts</a></li>
    <li><a class="dropdown-item" href="../articles/b-basic_usage.html">Basic usage</a></li>
    <li><a class="dropdown-item" href="../articles/c-polyglot.html">Polyglot pipelines and literate programming with Quarto</a></li>
    <li><a class="dropdown-item" href="../articles/d-ci.html">Running pipelines in CI</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/b-rodrigues/rixpress/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Introductory concepts</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/b-rodrigues/rixpress/blob/master/vignettes/a-intro_concepts.Rmd" class="external-link"><code>vignettes/a-intro_concepts.Rmd</code></a></small>
      <div class="d-none name"><code>a-intro_concepts.Rmd</code></div>
    </div>

    
    
<p>For a video version of this pipeline, <a href="youtube%20link%20to%20follow">click here</a>.</p>
<p>This vignette will introduce some jargon and walk you through setting
up a simple pipeline using <a href="https://github.com/b-rodrigues/rixpress/" class="external-link">rixpress</a>. It is useful, but
not mandatory, to understand the concepts laid out in this vignette; we
recommend you go through it, but if you don’t get everything at first,
don’t worry. Try building a simple pipeline by going through the next
vignette <code>vignette("b-basic-usage")</code> and come back to this
vignette afterwards, and things should be clearer!</p>
<div class="section level2">
<h2 id="definitions">Definitions<a class="anchor" aria-label="anchor" href="#definitions"></a>
</h2>
<p>In Nix jargon, a derivation <em>is a specification for running an
executable on precisely defined input files to repeatably produce output
files at uniquely determined file system paths.</em> (<a href="https://nix.dev/manual/nix/2.25/language/derivations" class="external-link">source</a>)</p>
<p>In simpler terms, a derivation is a recipe with precisely defined
inputs, steps, and a fixed output, meaning that for exactly the same
inputs and exactly the same build steps, exactly the same output is
produced. This is important to understand because to always build
exactly the same output, several measures must be taken:</p>
<ul>
<li>A derivation must have all of its inputs declared explicitly.</li>
<li>Inputs include software dependencies as well as configuration flags
or environment variables; in other words, anything necessary for a build
process.</li>
<li>To ensure the exact same output is always built, the build process
occurs in an <em>hermetic</em> sandbox.</li>
</ul>
<p>The next sections of this document explain these three points in more
detail.</p>
</div>
<div class="section level2">
<h2 id="derivations">Derivations<a class="anchor" aria-label="anchor" href="#derivations"></a>
</h2>
<p>Here is an example of a <em>simple</em> Nix expression:</p>
<pre><code>let
 pkgs = import (fetchTarball "https://github.com/rstats-on-nix/nixpkgs/archive/2025-04-11.tar.gz") {};

in

pkgs.stdenv.mkDerivation {
  name = "filtered_mtcars";
  buildInputs = [ pkgs.gawk ];
  dontUnpack = true;
  src = ./mtcars.csv;
  installPhase = ''
    mkdir -p $out
    awk -F',' 'NR==1 || $9=="1" { print }' $src &gt; $out/filtered.csv
  '';
}</code></pre>
<p>I will not go into details: the only thing that matters is that this
uses <code>awk</code>, a common unix data processing tool, to keep the
rows of the <code>mtcars.csv</code> file where its 9th column (the
<code>am</code> column) equals 1. As you can see, a lot of boilerplate
code must be written to perform this simple action. However, this is
entirely, and completely, reproducible: the dependencies are declared
and pinned to a dated branch of our <code>rstats-on-nix/nixpkgs</code>
fork, and the only think that could make this pipeline fail (well, it’s
a bit of a stretch to call this a <em>pipeline</em>) is if the
<code>mtcars.csv</code> file is not shared with it.</p>
<p>I could then add another step that uses <code>filtered.csv</code> as
an input and continue to process it. If we label the above code as
<code>f</code> and a subsequent chunk of Nix code to <code>g</code>,
then adding another step would essentially result in the following
computation: <code>mtcars |&gt; f |&gt; g</code>.</p>
<p>The goal of <a href="https://github.com/b-rodrigues/rixpress/" class="external-link">rixpress</a> is to help you write pipelines
like <code>mtcars |&gt; f |&gt; g</code> without needing to learn Nix,
but still benefit from its features.</p>
<p>Nix builds <code>filtered.csv</code> in two steps: it first generates
a <em>derivation</em> from this expression, and only then builds it. For
our purposes, I will be referring to the code as the one above as
<em>derivation</em>, instead of expression, this to avoid confusion with
the concept of <em>expression</em> in R.</p>
</div>
<div class="section level2">
<h2 id="dependencies-of-derivations">Dependencies of derivations<a class="anchor" aria-label="anchor" href="#dependencies-of-derivations"></a>
</h2>
<p>Nix requires dependencies of any derivation to be explicitely listed
and also managed by Nix itself. If you’re building your output and it
requires, say, Quarto, then Quarto must be explicitly listed as an
input, even if you already have Quarto installed on your system. The
same goes for Quarto’s dependencies, and all the dependencies of
dependencies of Quarto, all the way down to the common ancestor of all
packages. With Nix, to run a linear regression with R, you first need to
build the universe.</p>
<p>In Nix terms, this complete set of packages and their dependencies
are what its author, Eelco Dolstra, refers to as <em>component
closures</em>:</p>
<blockquote>
<p>The idea is to always deploy component closures: if we deploy a
component, then we must also deploy its dependencies, their
dependencies, and so on. That is, we must always deploy a set of
components that is closed under the ‘’depends on’’ relation. Since
closures are selfcontained, they are the units of complete software
deployment. After all, if a set of components is not closed, it is not
safe to deploy, since using them might cause other components to be
referenced that are missing on the target system.</p>
</blockquote>
<p>(<em>Nix: A Safe and Policy-Free System for Software Deployment</em>,
Dolstra et al., 2004).</p>
<p>The figure below, from the same paper illustrates this idea:</p>
<figure><img src="https://raw.githubusercontent.com/b-rodrigues/rixpress/refs/heads/master/vignettes/figure_4.png" alt="Figure 4 of Dolstra et al. (2004)"><figcaption aria-hidden="true">
Figure 4 of Dolstra et al. (2004)
</figcaption></figure><p>In the figure, <code>subversion</code> depends on
<code>openssl</code> which itself depends on <code>glibc</code>. So if
you write a derivation that is supposed to build a data frame that is
the result of a filter applied to <code>mtcars</code>, then this
derivation requires:</p>
<ul>
<li>An input file, say, <code>mtcars.csv</code>;</li>
<li>R and potentially R packages say <a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a>;</li>
<li>R’s and R packages dependencies;</li>
<li>the dependencies of the dependencies (all the way down).</li>
</ul>
<p>All need to be managed by Nix, because if one of these dependencies
is “outside” this component closure and only available on your machine,
then the pipeline only <em>works on your machine</em>!</p>
<p>Nix distinguishes between different types of dependencies
(<code>buildInputs</code>, <code>nativeBuildInputs</code>,
<code>propagatedBuildInputs</code>,
<code>propagatedNativeBuildInputs</code>) but we can skip this concept
which is only relevant for packaging upstream software, not to define
our pipelines. But if you’re curious, read <a href="https://gist.github.com/b-rodrigues/c677b59126d05d43347ed9623ddd5b0c" class="external-link">this</a>.</p>
</div>
<div class="section level2">
<h2 id="the-nix-store-and-hermetic-builds">The Nix store and hermetic builds<a class="anchor" aria-label="anchor" href="#the-nix-store-and-hermetic-builds"></a>
</h2>
<p>When building derivations, their outputs are saved into the so-called
<em>Nix store</em>. Typically located at <code>/nix/store/</code>, this
folder contains all the software and build artifacts produced by Nix.
Suppose you write a derivation that computes the tail of a file named
<code>mtcars.csv</code>. Once the derivation is built, its output would
be stored at a path similar to
<code>/nix/store/81k4s9q652jlka0c36khpscnmr8wk7jb-mtcars_tail</code>,
where the long cryptographic hash uniquely identifies the build output.
This hash is computed based on the content of the derivation along with
all its inputs and dependencies, thereby ensuring that the build is
fully reproducible. As a result, building the same derivation on two
different machines will yield the same cryptographic hash, and you can
replace the built artifact with the derivation that generates it
one-to-one. This is exactly like in mathematics; if you consider the
function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>:=</mo><msup><mi>x</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">f(x):= x^2</annotation></semantics></math>
then writing
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f(2)</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math>
is the same.</p>
<p>This mechanism is what makes it possible to import and export build
artifacts between pipelines to avoid having to rebuild everything from
scratch on different machines or on continuous integration platforms.
<a href="https://github.com/b-rodrigues/rixpress/" class="external-link">rixpress</a> has two functions that allow this, called
<code><a href="../reference/export_nix_archive.html">export_nix_archive()</a></code> and
<code><a href="../reference/import_nix_archive.html">import_nix_archive()</a></code>.</p>
<p>To ensure that building derivations always produces exactly the same
outputs, builds must occur in an isolated environment, often referred to
as a sandbox. This approach, known as a hermetic build process, ensures
that the build is unaffected by external factors.</p>
<p>The same goes for environment variables; for example, R users may
have to set the variable <code>JAVA_HOME</code> to make R aware of where
the Java runtime is installed. However, if Java is required for a
derivation, setting the variable <code>JAVA_HOME</code> outside of the
sandbox does not help; it must be set explicitly within the sandbox.
This also means that if you need to access an API to download some data,
it will not work because no connection to the internet is allowed from
within the build sandbox.</p>
<p>This may seem very restrictive, but if you think about it, it makes
sense if your goal is to achieve complete reproducibility. Indeed, say
that you need to use a function <code>f()</code> to access an API to get
data for your analysis: what guarantee do you have that running
<code>f()</code> today will yield the same result as running
<code>f()</code> in six months? One year? Will this API even still be
online? For reproducibility purposes, you should obtain the data from
this API, then version and/or archive it, and continue using this data
for your analysis (and share it with potential reproducers of your
study).</p>
</div>
<div class="section level2">
<h2 id="summary-and-conclusion">Summary and conclusion<a class="anchor" aria-label="anchor" href="#summary-and-conclusion"></a>
</h2>
<p>As explained at the start of this vignette, Nix will generate a
derivation from a Nix expression with a process called instantiation.
Writing a reproducible pipeline with Nix would mean having to write a
very long and complex Nix expression. <a href="https://github.com/b-rodrigues/rixpress/" class="external-link">rixpress</a> takes care
of this for you.</p>
<p>When instantiating an expression, Nix processes your declarations,
resolves all the inputs (including source files, build scripts, and
external dependencies), and computes a unique cryptographic hash. This
hash, derived from both the contents of your derivation and its entire
dependency graph, forms part of the derivation’s identity. Essentially,
it ensures that even the smallest change in your inputs will lead to a
distinct derivation, safeguarding reproducibility. To avoid confusion
with the concept of expression in R, we will be referring to Nix
expressions as <em>derivations</em>.</p>
<p>Once instantiated, derivations can be built. During the build
process, Nix constructs an isolated, hermetic environment where only the
explicitly declared dependencies are available. By doing so, the build
is entirely deterministic, meaning that the exact same inputs always
produce the same outputs, regardless of the machine or environment. This
isolation not only improves reliability but also facilitates debugging
and maintenance, as any external variability is removed from the
equation.</p>
<p>After a successful build, Nix stores the build output in the Nix
store (typically located at <code>/nix/store/</code>). For instance, if
you build a derivation that processes the <code>mtcars.csv</code> file,
the resultant output might be saved under a unique path such as
<code>/nix/store/81k4s9q652jlka0c36khpscnmr8wk7jb-mtcars_tail</code>.
The cryptographic hash is computed by taking into consideration the
derivation’s input and build process. If <em>anything</em> changes, the
hash will be different; this goes as far as if you change the separator
in the <code>mtcars.csv</code> data set from <code>,</code> to
<code>|</code>, then the resulting <code>mtcars_tail</code> object,
while looking exactly the same to us, will be different from the
perspective of Nix, because on of its inputs was different.</p>
<p>The lesson here, is that Nix is quite a complex tool, because it
solves quite a complex problem. <a href="https://github.com/b-rodrigues/rixpress/" class="external-link">rixpress</a> (and
<a href="https://docs.ropensci.org/rix/" class="external-link">rix</a>) are packages that aim to make Nix more accessible to
users of the R programming language.</p>
<p>Now that you are familiar with basic Nix concepts, let’s move on to
the next vignette to set up our first, basic, pipeline by going to the
<code>vignette("b-basic-usage")</code> vignette.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bruno Rodrigues.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
